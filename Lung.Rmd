---
title: "P8108 Final Project"
author: "Group 6"
date: "2025-11-16"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, WARNING = FALSE, MESSAGE = FALSE)
library(survival)
library(tidyverse)
library(gtsummary)
library(survminer)
library(survMisc)
```


## Data Import


```{r}
lung_df <- survival::lung %>%
  janitor::clean_names() %>%
  mutate(
    inst = as.factor(inst),
    time = as.numeric(time),
    status = as.factor(status),
    event = status == 2,
    age = as.numeric(age),
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    ph_ecog = factor(ph_ecog, ordered = TRUE),
    ph_karno = as.numeric(ph_karno),
    pat_karno = as.numeric(pat_karno),
    meal_cal = as.numeric(meal_cal),
    wt_loss = as.numeric(wt_loss)
  )
```
We create a new variable called `event` to indicate survival status, where 1 represents death and 0 represents censoring.

The variable `ph_ecog` (ECOG performance score, 0–3) is treated as an ordinal variable. For descriptive and Kaplan–Meier analyses, it is handled as a categorical factor to visualize group differences. It might be modeled as an ordinal numeric variable in Cox model.

## Check NAs

```{r}
summary(lung_df)

lung_cc <- lung_df %>%
  filter(complete.cases(time, event, age, sex, ph_ecog,
                        ph_karno, pat_karno, meal_cal, wt_loss, inst))
summary(lung_cc)
```

There are NAs in this data, so we will also create another dataset that observations with missing values will be excluded to ensure that all variables used in the analysis had complete information.

Both the original dataset and the complete-case dataset were retained for further analyses to allow comparisons and sensitivity checks.

## EDA

### Descriptive Table

```{r}
lung_cc %>%
  select(time, event, age, sex, ph_ecog, ph_karno, pat_karno, meal_cal, wt_loss) %>%
  tbl_summary(
    by = sex,
    missing = "no",
    statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} ({p}%)"),
    label = list(
      time ~ "Survival time (days)",
      event ~ "Death indicator",
      age ~ "Age (years)",
      ph_ecog ~ "ECOG performance status",
      ph_karno ~ "Physician Karnofsky score",
      pat_karno ~ "Patient Karnofsky score",
      meal_cal ~ "Meal calories",
      wt_loss ~ "Weight loss (kg)"
    )
  ) %>%
  add_overall() %>%
  add_p(test = everything() ~ "wilcox.test") %>%
  bold_labels()
```

### Age Distribution by Sex

```{r}
ggplot(lung_cc, aes(x = age, fill = sex)) +
  geom_histogram(bins = 25, position = "identity", alpha = 0.6) +
  theme_bw() +
  labs(title = "Age Distribution by Sex", x = "Age (years)", y = "Count")
```

### ECOG Performance Status by Sex

```{r}
ggplot(lung_cc, aes(x = ph_ecog, fill = sex)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  labs(title = "ECOG Performance Status by Sex", x = "ECOG", y = "Count")
```

### Physician-rated Karnofsky Score by Sex

```{r}
ggplot(lung_cc, aes(x = ph_karno, fill = sex)) +
  geom_density(alpha = 0.5) +
  theme_bw() +
  labs(title = "Physician-rated Karnofsky Score by Sex", x = "Score", y = "Density")
```

### Meal Calories and Weight Loss Distributions

```{r}
p1 <- ggplot(lung_cc, aes(x = meal_cal, fill = sex)) +
  geom_density(alpha = 0.4) +
  labs(title = "Meal Calories Distribution", x = "Calories", y = "Density") +
  theme_bw()

p2 <- ggplot(lung_cc, aes(x = wt_loss, fill = sex)) +
  geom_density(alpha = 0.4) +
  labs(title = "Weight Loss Distribution", x = "Weight loss (kg)", y = "Density") +
  theme_bw()

p1; p2
```


### Distribution of Survival Time

```{r}
ggplot(lung_cc, aes(x = time, fill = event)) +
  geom_histogram(bins = 30, alpha = 0.6) +
  theme_bw() +
  labs(title = "Distribution of Survival Time", x = "Time (days)", y = "Count") +
  scale_fill_manual(values = c("PINK", "RED"), name = "Event", labels = c("Censored", "Death"))
```


## Comparison of Survival Curves

```{r}
# Create a survival object, which bundles the time and event data
surv_object <- Surv(time = lung_cc$time, event = lung_cc$event)

```

```{r}
# Fit the Overall Kaplan-Meier Model
km_overall_fit <- survfit(surv_object ~ 1, data = lung_cc)

print(km_overall_fit)

ggsurvplot(
  km_overall_fit,
  data = lung_cc,
  conf.int = TRUE,    
  risk.table = TRUE,   
  risk.table.col = "strata", 
  title = "Overall Kaplan-Meier Survival Curve",
  xlab = "Time in Days",
  ylab = "Survival Probability",
  ggtheme = theme_bw(),  
  palette = "darkblue",  
  legend = "none"      
)
```

### Sex
```{r}
# Fit the Kaplan-Meier model to estimate survival curves for each group ('sex')
km_sex_fit <- survfit(surv_object ~ sex, data = lung_cc)

summary(km_sex_fit)


# --- Visualize the Estimated Survival Probabilities ---

# Generate the Kaplan-Meier plot using ggsurvplot
ggsurvplot(
  km_sex_fit,
  data = lung_cc,
  pval = TRUE,                 # The p-value from the log-rank test will be displayed
  conf.int = TRUE,             # Display confidence intervals for the curves
  risk.table = TRUE,           # Add a table showing the number of subjects at risk
  risk.table.col = "strata",   # Color the risk table to match the curves
  legend.labs = c("Male", "Female"),
  legend.title = "Sex",
  xlab = "Time in Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curves by Sex",
  ggtheme = theme_bw()         # Apply a clean theme
)

```

```{r}
# With rho = 0 this is the log-rank or Mantel-Haenszel test, and with rho = 1 it is equivalent to the Peto & Peto modification of the Gehan-Wilcoxon test.
log_rank_sex <- survdiff(surv_object ~ sex, data = lung_cc, rho = 0)
print(log_rank_sex)

wilcoxon_sex <- survdiff(surv_object ~ sex, data = lung_cc, rho = 1)
print(wilcoxon_sex)

```

The p-value is even smaller than the log-rank p-value. This not only confirms the result of the log-rank test but also suggests that the survival advantage for females is particularly pronounced at the beginning and middle of the follow-up period.

```{r}
# Fleming-Harrington test statistic
fit_sex <- ten(surv_object ~ sex, data = lung_cc)
comp(fit_sex)

lrt_mat <- attr(fit_sex, "lrt")
data.frame(
test = c("Log-Rank", "Wilcoxon", "Tarone", "Peto", "Modified-Peto", "FH(1, 1)"),
Z_squared = lrt_mat[, "Z"]^2
)

```

The final summary table (Z_squared) shows that regardless of the specific test used, the result is always highly significant (all Z^2 values correspond to p-values well below 0.05). 

### ECOG performance status (unstratified)
```{r}
# --- Fit the Kaplan-Meier model for ph_ecog ---
km_ecog_fit <- survfit(surv_object ~ ph_ecog, data = lung_cc)

summary(km_ecog_fit)

ggsurvplot(
  km_ecog_fit,
  data = lung_cc,
  
  # --- Add Key Statistical Information ---
  pval = TRUE,                 # Display the log-rank test p-value
  conf.int = TRUE,             # Show 95% confidence intervals
  
  # --- Add Contextual Information ---
  risk.table = TRUE,           # Include a table showing the number of patients at risk
  risk.table.y.text.col = TRUE,# Color the risk table text to match curves
  risk.table.y.text = FALSE,   # Remove y-axis tick labels from the risk table
  
  # --- Customize Aesthetics and Labels ---
  title = "Kaplan-Meier Survival Curves by ECOG Performance Status",
  xlab = "Time in Days",
  ylab = "Survival Probability",
  legend.title = "ECOG Status",
  # Provide clear, descriptive labels for each group in the legend
  legend.labs = c(
    "0 (Asymptomatic)", 
    "1 (Symptomatic, Ambulatory)", 
    "2 (In bed <50% of day)", 
    "3 (In bed >50% of day)"
  ),
  ggtheme = theme_bw()         # Use a clean black and white theme
)

# --- Perform the test ---
log_rank_ecog <- survdiff(surv_object ~ ph_ecog, data = lung_cc, rho = 0)
print(log_rank_ecog)

wilcoxon_ecog <- survdiff(surv_object ~ ph_ecog, data = lung_cc, rho = 1)
print(wilcoxon_ecog)
```

The fact that the Wilcoxon test yields a smaller p-value than the log-rank test suggests that the survival differences between the groups are particularly pronounced early in the follow-up period. 

### ECOG performance status (stratified by sex)
```{r}
log_rank_ecog_bysex <- survdiff(surv_object ~ ph_ecog + strata(sex), data = lung_cc, rho = 0)
print(log_rank_ecog_bysex)

wilcoxon_ecog_bysex <- survdiff(surv_object ~ ph_ecog + strata(sex), data = lung_cc, rho = 1)
print(wilcoxon_ecog_bysex)
```

Log-rank: The result is virtually identical to the unstratified test. The Chi-square statistic and the p-value have barely changed. It means that the strong predictive power of ECOG status is independent of the patient's sex. The effect is not being confounded by sex.

Wilcoxon: After stratifying by sex, the Chi-square value increased (from 20.8 to 23.4) and the p-value became even smaller. This suggests that after controlling for the baseline survival differences between sexes, the effect of ECOG status on early deaths becomes even more pronounced and clear.

Final summary for stratified analysis:
ECOG is an Independent Predictor: The effect of ECOG performance status on survival is not explained away by the patient's sex. It is a strong, independent prognostic factor. Sex is not acting as a major confounder in the relationship between ECOG status and survival. Whether a patient is male or female, having a worse ECOG score (e.g., a score of 2 vs. 0) is strongly associated with a significantly poorer survival outcome. The effect holds true within both groups.