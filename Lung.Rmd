---
title: "P8108 Final Project"
author: "Group 6"
date: "2025-11-16"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, WARNING = FALSE, MESSAGE = FALSE)
library(survival)
library(tidyverse)
library(gtsummary)
library(survminer)
library(survMisc)
library(knitr)
library(kableExtra) 
```


## Data Import


```{r}
lung_df <- survival::lung %>%
  janitor::clean_names() %>%
  mutate(
    inst = as.factor(inst),
    time = as.numeric(time),
    status = as.factor(status),
    event = status == 2,
    age = as.numeric(age),
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    ph_ecog = factor(ph_ecog, ordered = TRUE),
    ph_karno = as.numeric(ph_karno),
    pat_karno = as.numeric(pat_karno),
    meal_cal = as.numeric(meal_cal),
    wt_loss = as.numeric(wt_loss)
  )
```
We create a new variable called `event` to indicate survival status, where 1 represents death and 0 represents censoring.

The variable `ph_ecog` (ECOG performance score, 0–3) is treated as an ordinal variable. For descriptive and Kaplan–Meier analyses, it is handled as a categorical factor to visualize group differences. It might be modeled as an ordinal numeric variable in Cox model.

## Check NAs

```{r}
summary(lung_df)

lung_cc <- lung_df %>%
  filter(complete.cases(time, event, age, sex, ph_ecog,
                        ph_karno, pat_karno, meal_cal, wt_loss, inst))
summary(lung_cc)
```

There are NAs in this data, so we will also create another dataset that observations with missing values will be excluded to ensure that all variables used in the analysis had complete information.

Both the original dataset and the complete-case dataset were retained for further analyses to allow comparisons and sensitivity checks.

## EDA

### Descriptive Table

```{r}
lung_cc %>%
  select(time, event, age, sex, ph_ecog, ph_karno, pat_karno, meal_cal, wt_loss) %>%
  tbl_summary(
    by = sex,
    missing = "no",
    statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} ({p}%)"),
    label = list(
      time ~ "Survival time (days)",
      event ~ "Death indicator",
      age ~ "Age (years)",
      ph_ecog ~ "ECOG performance status",
      ph_karno ~ "Physician Karnofsky score",
      pat_karno ~ "Patient Karnofsky score",
      meal_cal ~ "Meal calories",
      wt_loss ~ "Weight loss (kg)"
    )
  ) %>%
  add_overall() %>%
  add_p(test = everything() ~ "wilcox.test") %>%
  bold_labels()
```

### Age Distribution by Sex

```{r}
ggplot(lung_cc, aes(x = age, fill = sex)) +
  geom_histogram(bins = 25, position = "identity", alpha = 0.6) +
  theme_bw() +
  labs(title = "Age Distribution by Sex", x = "Age (years)", y = "Count")
```

### ECOG Performance Status by Sex

```{r}
ggplot(lung_cc, aes(x = ph_ecog, fill = sex)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  labs(title = "ECOG Performance Status by Sex", x = "ECOG", y = "Count")
```

### Physician-rated Karnofsky Score by Sex

```{r}
ggplot(lung_cc, aes(x = ph_karno, fill = sex)) +
  geom_density(alpha = 0.5) +
  theme_bw() +
  labs(title = "Physician-rated Karnofsky Score by Sex", x = "Score", y = "Density")
```

### Meal Calories and Weight Loss Distributions

```{r}
p1 <- ggplot(lung_cc, aes(x = meal_cal, fill = sex)) +
  geom_density(alpha = 0.4) +
  labs(title = "Meal Calories Distribution", x = "Calories", y = "Density") +
  theme_bw()

p2 <- ggplot(lung_cc, aes(x = wt_loss, fill = sex)) +
  geom_density(alpha = 0.4) +
  labs(title = "Weight Loss Distribution", x = "Weight loss (kg)", y = "Density") +
  theme_bw()

p1; p2
```


### Distribution of Survival Time

```{r}
ggplot(lung_cc, aes(x = time, fill = event)) +
  geom_histogram(bins = 30, alpha = 0.6) +
  theme_bw() +
  labs(title = "Distribution of Survival Time", x = "Time (days)", y = "Count") +
  scale_fill_manual(values = c("PINK", "RED"), name = "Event", labels = c("Censored", "Death"))
```


## Comparison of Survival Curves

```{r}
# Create a survival object, which bundles the time and event data
surv_object <- Surv(time = lung_cc$time, event = lung_cc$event)

```

```{r}
# Fit the Overall Kaplan-Meier Model
km_overall_fit <- survfit(surv_object ~ 1, data = lung_cc)

print(km_overall_fit)

ggsurvplot(
  km_overall_fit,
  data = lung_cc,
  conf.int = TRUE,    
  risk.table = TRUE,   
  risk.table.col = "strata", 
  title = "Overall Kaplan-Meier Survival Curve",
  xlab = "Time in Days",
  ylab = "Survival Probability",
  ggtheme = theme_bw(),  
  palette = "darkblue",  
  legend = "none"      
)
```

### Sex
```{r}
# Fit the Kaplan-Meier model to estimate survival curves for each group ('sex')
km_sex_fit <- survfit(surv_object ~ sex, data = lung_cc)

summary(km_sex_fit)


# --- Visualize the Estimated Survival Probabilities ---

# Generate the Kaplan-Meier plot using ggsurvplot
ggsurvplot(
  km_sex_fit,
  data = lung_cc,
  pval = TRUE,                 # The p-value from the log-rank test will be displayed
  conf.int = TRUE,             # Display confidence intervals for the curves
  risk.table = TRUE,           # Add a table showing the number of subjects at risk
  risk.table.col = "strata",   # Color the risk table to match the curves
  legend.labs = c("Male", "Female"),
  legend.title = "Sex",
  xlab = "Time in Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curves by Sex",
  ggtheme = theme_bw()         # Apply a clean theme
)

```

```{r}
# With rho = 0 this is the log-rank or Mantel-Haenszel test, and with rho = 1 it is equivalent to the Peto & Peto modification of the Gehan-Wilcoxon test.
log_rank_sex <- survdiff(surv_object ~ sex, data = lung_cc, rho = 0)
print(log_rank_sex)

wilcoxon_sex <- survdiff(surv_object ~ sex, data = lung_cc, rho = 1)
print(wilcoxon_sex)

```

The p-value is even smaller than the log-rank p-value. This not only confirms the result of the log-rank test but also suggests that the survival advantage for females is particularly pronounced at the beginning and middle of the follow-up period.

```{r}
# Fleming-Harrington test statistic
fit_sex <- ten(surv_object ~ sex, data = lung_cc)
comp(fit_sex)

lrt_mat <- attr(fit_sex, "lrt")
data.frame(
test = c("Log-Rank", "Wilcoxon", "Tarone", "Peto", "Modified-Peto", "FH(1, 1)"),
Z_squared = lrt_mat[, "Z"]^2
)

```

The final summary table (Z_squared) shows that regardless of the specific test used, the result is always highly significant (all Z^2 values correspond to p-values well below 0.05). 

### ECOG performance status (unstratified)
```{r}
# --- Fit the Kaplan-Meier model for ph_ecog ---
km_ecog_fit <- survfit(surv_object ~ ph_ecog, data = lung_cc)

summary(km_ecog_fit)

ggsurvplot(
  km_ecog_fit,
  data = lung_cc,
  
  # --- Add Key Statistical Information ---
  pval = TRUE,                 # Display the log-rank test p-value
  conf.int = FALSE,             # Show 95% confidence intervals
  
  # --- Add Contextual Information ---
  risk.table = TRUE,           # Include a table showing the number of patients at risk
  risk.table.y.text.col = TRUE,# Color the risk table text to match curves
  risk.table.y.text = FALSE,   # Remove y-axis tick labels from the risk table
  
  # --- Customize Aesthetics and Labels ---
  title = "Kaplan-Meier Survival Curves by ECOG Performance Status",
  xlab = "Time in Days",
  ylab = "Survival Probability",
  legend.title = "ECOG Status",
  # Provide clear, descriptive labels for each group in the legend
  legend.labs = c(
    "0 (Asymptomatic)", 
    "1 (Symptomatic, Ambulatory)", 
    "2 (In bed <50% of day)", 
    "3 (In bed >50% of day)"
  ),
  ggtheme = theme_bw()         # Use a clean black and white theme
)

# --- Perform the test ---
log_rank_ecog <- survdiff(surv_object ~ ph_ecog, data = lung_cc, rho = 0)
print(log_rank_ecog)

wilcoxon_ecog <- survdiff(surv_object ~ ph_ecog, data = lung_cc, rho = 1)
print(wilcoxon_ecog)
```

The fact that the Wilcoxon test yields a smaller p-value than the log-rank test suggests that the survival differences between the groups are particularly pronounced early in the follow-up period. 

### ECOG performance status (stratified by sex)
```{r}
log_rank_ecog_bysex <- survdiff(surv_object ~ ph_ecog + strata(sex), data = lung_cc, rho = 0)
print(log_rank_ecog_bysex)

wilcoxon_ecog_bysex <- survdiff(surv_object ~ ph_ecog + strata(sex), data = lung_cc, rho = 1)
print(wilcoxon_ecog_bysex)
```

Log-rank: The result is virtually identical to the unstratified test. The Chi-square statistic and the p-value have barely changed. It means that the strong predictive power of ECOG status is independent of the patient's sex. The effect is not being confounded by sex.

Wilcoxon: After stratifying by sex, the Chi-square value increased (from 20.8 to 23.4) and the p-value became even smaller. This suggests that after controlling for the baseline survival differences between sexes, the effect of ECOG status on early deaths becomes even more pronounced and clear.

Final summary for stratified analysis:
ECOG is an Independent Predictor: The effect of ECOG performance status on survival is not explained away by the patient's sex. It is a strong, independent prognostic factor. Sex is not acting as a major confounder in the relationship between ECOG status and survival. Whether a patient is male or female, having a worse ECOG score (e.g., a score of 2 vs. 0) is strongly associated with a significantly poorer survival outcome. The effect holds true within both groups.

## Cox model
### Univariate Cox Regression (Single-variable screening)
```{r}
# List of all predictor variables to test
predictors <- c("age", "sex", "ph_ecog", "ph_karno", "pat_karno", "meal_cal", "wt_loss")

# Create an empty list to store results
univariate_results <- list()

# Loop through each predictor and fit a univariate Cox model
for (var in predictors) {
  formula <- as.formula(paste("Surv(time, event) ~", var))
  cox_model <- coxph(formula, data = lung_cc)
  
  # Extract coefficients, HR, CI, and p-value
  summary_model <- summary(cox_model)
  
  univariate_results[[var]] <- data.frame(
    Variable = var,
    HR = summary_model$conf.int[1, "exp(coef)"],
    Lower_CI = summary_model$conf.int[1, "lower .95"],
    Upper_CI = summary_model$conf.int[1, "upper .95"],
    P_value = summary_model$coefficients[1, "Pr(>|z|)"]
  )
}

# Combine all results into one table
univariate_table <- do.call(rbind, univariate_results)
rownames(univariate_table) <- NULL

# Display the table
print(univariate_table)

# Create a more detailed summary table using gtsummary
tbl_univariate <- 
  tbl_uvregression(
    lung_cc %>% select(time, event, age, sex, ph_ecog, ph_karno, pat_karno, meal_cal, wt_loss),
    method = coxph,
    y = Surv(time, event),
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 3)
  ) %>%
  bold_p(t = 0.05) %>%
  bold_labels()

tbl_univariate
```
In univariable Cox models, female sex was associated with a substantially lower hazard of death compared with males (HR 0.62, 95% CI 0.42–0.91, p=0.015). Worse ECOG performance status showed a significant linear trend toward higher mortality risk (p for linear trend = 0.024). Higher patient-rated Karnofsky score was strongly protective (HR 0.98 per point, 95% CI 0.97–0.99, p=0.002). Age and physician-rated Karnofsky score exhibited borderline associations with survival, whereas meal calories and weight loss were not significantly associated with overall survival in univariable analyses

### Variable Selection
```{r}
significant_vars <- univariate_table %>%
  filter(P_value < 0.10) %>%
  pull(Variable)

print("Variables selected for multivariable model (p < 0.10):")
print(significant_vars)

```
Covariates with p < 0.10 in univariable Cox models were considered as candidates for the multivariable model. Given the strong clinical relevance, age and sex were retained a priori. Because physician- and patient-rated Karnofsky scores are highly correlated, we included only the patient-rated score (pat_karno), which showed a stronger univariable association (p=0.002), in the primary model.

### Multivariable Cox Regression (Initial Model)
```{r}
cox_multi_model <- coxph(Surv(time, event) ~ age + sex + ph_ecog + pat_karno, 
                         data = lung_cc)

summary(cox_multi_model)
```
In the initial multivariable Cox model including age, sex, ECOG performance status, and patient-rated Karnofsky score, the overall model was statistically significant (likelihood ratio test p = 0.002), with a concordance index of 0.65, indicating moderate discriminative ability. After adjustment for the other covariates, female patients had a substantially lower hazard of death compared with males (HR 0.62, 95% CI 0.42–0.91, p = 0.015). ECOG performance status showed a borderline linear trend toward higher mortality (HR 3.76 for a one-step worsening in ECOG, 95% CI 0.93–15.19, p = 0.063). In contrast, age and patient-rated Karnofsky score were not significantly associated with survival in this multivariable model (all p > 0.40).

### Tied Events Handling + Model Simplification
```{r}
cox_multi_efron <- coxph(
  Surv(time, event) ~ age + sex + ph_ecog + pat_karno,
  data = lung_cc,
  ties = "efron"
)

cox_multi_breslow <- coxph(
  Surv(time, event) ~ age + sex + ph_ecog + pat_karno,
  data = lung_cc,
  ties = "breslow"
)

summary(cox_multi_efron)
summary(cox_multi_breslow)

```
To assess the impact of tied event times, we refit the multivariable Cox model using both the Efron and Breslow methods for handling ties. The estimated hazard ratios, confidence intervals, and p-values were nearly identical across the two approaches, and the concordance index remained 0.65 in both models. These findings suggest that ties had minimal influence on the results, and we therefore used the Efron method in all subsequent analyses.

### Model Simplification
```{r}
# Remove non-significant variables (age, pat_karno)
# Test 3 simplified models

# Model A: Sex only (most parsimonious)
cox_model_A <- coxph(Surv(time, event) ~ sex, data = lung_cc)

# Model B: Sex + ph_ecog (categorical)
cox_model_B <- coxph(Surv(time, event) ~ sex + ph_ecog, data = lung_cc)

# Model C: Sex + ph_ecog (as numeric/ordinal)
lung_cc <- lung_cc %>%
  mutate(ph_ecog_num = as.numeric(as.character(ph_ecog)))

cox_model_C <- coxph(Surv(time, event) ~ sex + ph_ecog_num, data = lung_cc)

# Display all models
cat("========================================\n")
cat("Model A: Sex Only\n")
cat("========================================\n")
summary(cox_model_A)

cat("\n========================================\n")
cat("Model B: Sex + ECOG (Categorical)\n")
cat("========================================\n")
summary(cox_model_B)

cat("\n========================================\n")
cat("Model C: Sex + ECOG (Numeric)\n")
cat("========================================\n")
summary(cox_model_C)

# Model comparison
cat("\n========================================\n")
cat("MODEL COMPARISON SUMMARY\n")
cat("========================================\n")

# Extract metrics
aic_A <- AIC(cox_model_A)
aic_B <- AIC(cox_model_B)
aic_C <- AIC(cox_model_C)

c_A <- summary(cox_model_A)$concordance[1]
c_B <- summary(cox_model_B)$concordance[1]
c_C <- summary(cox_model_C)$concordance[1]

cat("\nModel A (sex only):\n")
cat("  AIC =", round(aic_A, 2), "\n")
cat("  C-index =", round(c_A, 3), "\n")

cat("\nModel B (sex + ph_ecog categorical):\n")
cat("  AIC =", round(aic_B, 2), "\n")
cat("  C-index =", round(c_B, 3), "\n")

cat("\nModel C (sex + ph_ecog numeric):\n")
cat("  AIC =", round(aic_C, 2), "\n")
cat("  C-index =", round(c_C, 3), "\n")

cat("\nNote: Lower AIC = Better fit\n")
cat("      Higher C-index = Better discrimination\n")

# Likelihood Ratio Tests
cat("\n========================================\n")
cat("LIKELIHOOD RATIO TESTS\n")
cat("========================================\n")

cat("\n--- Test 1: Model A vs Model B ---\n")
cat("(Does adding ph_ecog categorical improve the model?)\n")
lrt_AB <- anova(cox_model_A, cox_model_B, test = "Chisq")
print(lrt_AB)

cat("\n--- Test 2: Model A vs Model C ---\n")
cat("(Does adding ph_ecog numeric improve the model?)\n")
lrt_AC <- anova(cox_model_A, cox_model_C, test = "Chisq")
print(lrt_AC)

cat("\n--- Test 3: Model B vs Model C ---\n")
cat("(Is categorical or numeric ph_ecog better?)\n")
lrt_BC <- anova(cox_model_C, cox_model_B, test = "Chisq")
print(lrt_BC)
```

Starting from a multivariable model including age, sex, ECOG performance status, and patient-rated Karnofsky score, we removed age (p=0.565) and patient-rated Karnofsky score (p=0.431) as they were not statistically significant after adjustment for other covariates. We then compared three 
reduced Cox models: (A) sex only, (B) sex plus ECOG treated as a categorical factor, and (C) sex plus ECOG treated as a numeric ordinal variable (0–3).

Adding ECOG status substantially improved model fit compared with the sex-only model. For model B, the likelihood ratio test versus model A yielded $\chi^2$=14.14 on 3 df (p=0.003), with concordance increasing from 0.567 to 0.646. For model C, the likelihood ratio test versus model A yielded $\chi^2$=13.24 on 1 df (p<0.001), with concordance of 0.641. Models B and C demonstrated similar performance (AIC=1003.84 vs 1000.75; C-index=0.646 vs 0.641), with no significant difference between them ($\chi^2$=0.91 on 2 df, p=0.635). 

We selected model C (sex + ECOG as a numeric ordinal variable) as the final Cox model based on the principle of parsimony: it achieved similar predictive performance with fewer parameters (2 vs 4) and offered a simpler, more interpretable linear effect for ECOG performance status.

### Check assumptions
```{r}
ph_test = cox.zph(cox_model_C)
ph_test
```

```{r}
par(mfrow = c(1,2))
plot(ph_test)
par(mfrow = c(1,1))
```
The proportional hazards assumption was evaluated using Schoenfeld residuals. The effect of sex met the PH assumption (p = 0.266), with residual plots showing no meaningful time trend. However, ph_ecog_num showed a statistically significant deviation from proportional hazards (p = 0.022), and its residual plot displayed a clear time-varying pattern. The global test was also statistically significant (p = 0.045), further indicating model-level violation of the PH assumption. These findings suggest that the effect of ECOG performance status may vary over time, and the current Cox model may not fully satisfy the PH assumption. Thus, we might considering remove the ECOG variable, and only include sex into our final survival model.


# AFT Model Analysis (Addressing PH Violation)

Since `ph_ecog` violated the proportional hazards assumption (p = 0.022), we fit Accelerated Failure Time (AFT) models as an alternative approach. AFT models do not require the PH assumption and provide **time ratios** that are often more clinically interpretable.

### Fit Multiple AFT Models
```{r aft_models}
# Fit AFT models with different distributions
# Model: time ~ sex + ph_ecog_num

# 1. Exponential
aft_exp <- survreg(Surv(time, event) ~ sex + ph_ecog_num,
                   data = lung_cc, dist = "exponential")

# 2. Weibull (most common, allows PH interpretation)
aft_weibull <- survreg(Surv(time, event) ~ sex + ph_ecog_num,
                       data = lung_cc, dist = "weibull")

# 3. Log-Normal
aft_lnorm <- survreg(Surv(time, event) ~ sex + ph_ecog_num,
                     data = lung_cc, dist = "lognormal")

# 4. Log-Logistic
aft_llogis <- survreg(Surv(time, event) ~ sex + ph_ecog_num,
                      data = lung_cc, dist = "loglogistic")
```

### Model Comparison
```{r aft_comparison}
# Compare models using AIC
model_comparison <- data.frame(
  Model = c("Exponential", "Weibull", "Log-Normal", "Log-Logistic"),
  LogLik = c(logLik(aft_exp)[1], logLik(aft_weibull)[1],
             logLik(aft_lnorm)[1], logLik(aft_llogis)[1]),
  AIC = c(AIC(aft_exp), AIC(aft_weibull), 
          AIC(aft_lnorm), AIC(aft_llogis)),
  Parameters = c(3, 4, 4, 4)
) %>%
  mutate(Delta_AIC = AIC - min(AIC)) %>%
  arrange(AIC)

kable(model_comparison, digits = 2,
      caption = "AFT Model Comparison (Lower AIC = Better)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

best_model <- model_comparison$Model[1]
cat("\nBest model by AIC:", best_model, "\n")
```

### Likelihood Ratio Test
```{r lrt_test}
# Test if Weibull significantly better than Exponential
lrt_stat <- 2 * (logLik(aft_weibull)[1] - logLik(aft_exp)[1])
p_value <- pchisq(lrt_stat, df = 1, lower.tail = FALSE)

cat("LR Chi-square:", round(lrt_stat, 3), "\n")
cat("df: 1\n")
cat("p-value:", format.pval(p_value, digits = 3), "\n\n")

if (p_value < 0.05) {
  cat("Result: Weibull is significantly better (p < 0.05)\n")
} else {
  cat("Result: No significant difference\n")
}
```


### Final AFT Model Results
```{r aft_final_model}
cat("============================================\n")
cat("FINAL WEIBULL AFT MODEL\n")
cat("============================================\n\n")

cat("Model Selection Rationale:\n")
cat("- Weibull had the lowest AIC among all distributions tested\n")
cat("- LR test: Weibull significantly better than Exponential (p < 0.001)\n")
cat("- Variables: sex + ph_ecog_num (reduced model)\n\n")

cat("Weibull Parameters:\n")
cat("- Scale ($\\sigma$):", round(aft_weibull$scale, 4), "\n")
cat("- Shape ($\\kappa = 1/\\sigma$):", round(1/aft_weibull$scale, 4), "\n")
cat("- Interpretation: $\\kappa > 1$ indicates INCREASING hazard over time\n\n")

# Get coefficients  
aft_sum <- summary(aft_weibull)$table   

coefs <- aft_sum[-1, "Value"]         
se    <- aft_sum[-1, "Std. Error"]
names(coefs) <- rownames(aft_sum)[-1]

n_coef <- length(coefs)

final_aft_results <- data.frame(
  Variable   = names(coefs),
  Beta_AFT   = as.numeric(coefs),
  SE         = as.numeric(se),
  Time_Ratio = exp(coefs),
  Lower_95CI = exp(coefs - 1.96 * se),
  Upper_95CI = exp(coefs + 1.96 * se),
  p_value    = 2 * pnorm(-abs(coefs / se)),
  stringsAsFactors = FALSE
)

kable(final_aft_results, digits = 3,
      caption = "Weibull AFT Model Results")

```
In the Weibull AFT model ($\sigma$ = 0.73, $\kappa$ = 1.38), both sex and ECOG performance status were significant independent predictors of survival time.
Sex: Female patients demonstrated significantly longer median survival compared to males (Time Ratio [TR] = 1.45, 95% CI: 1.09–1.93, p = 0.01), with an estimated 45% increase in median survival time.
ECOG Performance Status: Each one-unit worsening in ECOG score was associated with a 30% reduction in median survival time (TR = 0.70, 95% CI: 0.58–0.85, p < 0.001).

## Clinical Interpretation
```{r aft_interpretation}
cat("============================================\n")
cat("CLINICAL INTERPRETATION (AFT Model)\n")
cat("============================================\n\n")

# Sex effect
tr_sex <- final_aft_results$Time_Ratio[1]
pct_sex <- (tr_sex - 1) * 100

cat("1. Sex (Female vs Male):\n")
cat("   Time Ratio:", round(tr_sex, 3), "\n")
if (tr_sex > 1) {
  cat("   Females have", round(pct_sex, 1), "% LONGER median survival\n\n")
} else {
  cat("   Females have", round(abs(pct_sex), 1), "% SHORTER median survival\n\n")
}

# ECOG effect
tr_ecog <- final_aft_results$Time_Ratio[2]
pct_ecog <- (tr_ecog - 1) * 100

cat("2. ECOG (per 1-unit increase):\n")
cat("   Time Ratio:", round(tr_ecog, 3), "\n")
if (tr_ecog < 1) {
  cat("   Each 1-unit worsening reduces survival by", round(abs(pct_ecog), 1), "%\n\n")
} else {
  cat("   Each 1-unit worsening increases survival by", round(pct_ecog, 1), "%\n\n")
}

# Example
cat("Example:\n")
cat("If a male with ECOG=0 has median survival of 300 days:\n")
cat("  - Male, ECOG=1:   ", round(300 * tr_ecog, 0), "days\n")
cat("  - Female, ECOG=0: ", round(300 * tr_sex, 0), "days\n")
cat("  - Female, ECOG=1: ", round(300 * tr_sex * tr_ecog, 0), "days\n")
```
In the Weibull AFT model, female sex is associated with ~45% longer survival time compared with males, adjusting for ECOG. Each 1-point worsening in ECOG score is associated with ~30% shorter survival time. For example, if a male patient with ECOG 0 has a median survival of 300 days, the model predicts 211 days for a male with ECOG 1, 435 days for a female with ECOG 0, and 306 days for a female with ECOG 1.

### Weibull AFT to Hazard Ratios
```{r aft_to_ph}
if (best_model == "Weibull") {
  cat("============================================\n")
  cat("WEIBULL AFT to PH CONVERSION\n")
  cat("============================================\n\n")
  
  sigma <- aft_weibull$scale
  beta_aft <- coef(aft_weibull)[-1]
  beta_ph <- -beta_aft / sigma
  hr <- exp(beta_ph)
  
  conversion_table <- data.frame(
    Variable = names(beta_aft),
    AFT_TimeRatio = exp(beta_aft),
    Converted_HR = hr,
    Cox_HR = exp(coef(cox_model_C))
  )
  
  kable(conversion_table, digits = 3,
        caption = "AFT vs Cox: Time Ratios and Hazard Ratios") %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
  
  cat("\nNote: Weibull AFT and Cox PH give similar HRs\n")
}
```

## Summary
```{r summary_aft}
cat("============================================\n")
cat("SUMMARY: AFT vs COX\n")
cat("============================================\n\n")

cat("1. PH ASSUMPTION:\n")
cat("   - Cox: ph_ecog violated (p=0.022)\n")
cat("   - AFT: NO assumption required ✓\n\n")

cat("2. INTERPRETATION:\n")
cat("   - Cox: Hazard Ratios\n")
cat("   - AFT: Time Ratios (more intuitive)\n\n")

cat("3. KEY FINDINGS:\n")
cat("   - Female sex: protective effect\n")
cat("   - ECOG worse: shorter survival\n")
cat("   - Consistent across methods ✓\n\n")

```


